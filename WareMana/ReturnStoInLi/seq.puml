@startuml
title Sequence Diagram - Return Stock Input List (Search Return Orders)
autonumber

actor "Warehouse Manager" as Manager
participant ":ReturnOrderController" as Controller
participant ":ReturnTransactionService" as ReturnService
participant ":WarehouseService" as WarehouseService
participant ":UserService" as UserService
participant ":SupplierService" as SupplierService
participant "Database" as DB

' Step 1: User Request
Manager -> Controller: POST /api/returnorder/GetData(search)
activate Controller

' Step 2: Get Raw Data
Controller -> ReturnService: GetData(search)
activate ReturnService
ReturnService -> DB: Query ReturnTransactions
activate DB
DB --> ReturnService: PagedList<ReturnOrderDto>
deactivate DB
ReturnService --> Controller: result
deactivate ReturnService

' Step 3: Bulk Fetch Warehouses
Controller -> Controller: Extract listWarehouseId
Controller -> WarehouseService: GetByListWarehouseId(listWarehouseId)
activate WarehouseService
WarehouseService -> DB: Query Warehouses
activate DB
DB --> WarehouseService: List<Warehouse>
deactivate DB
WarehouseService --> Controller: listWareHouse
deactivate WarehouseService

' Step 4: Bulk Fetch Customers (for Export returns)
Controller -> Controller: Extract listCustomerId (from Export items)
Controller -> UserService: GetAll()
activate UserService
UserService -> DB: Query Users
activate DB
DB --> UserService: List<User>
deactivate DB
UserService --> Controller: listUser
deactivate UserService

' Step 5: Enrich Data Loop
loop For each ReturnOrderDto in result
    ' Map Warehouse Name
    Controller -> Controller: Find Warehouse in listWareHouse
    Controller -> Controller: item.WarehouseName = warehouse.WarehouseName

    alt TransactionType == "Export"
    autonumber 18
        ' Map Customer Name
        Controller -> Controller: Find User in listUser
        Controller -> Controller: item.CustomerName = user.FullName
    else TransactionType == "Import"
    autonumber 18.1
        ' Map Supplier Name (Fetch individually)
        Controller -> SupplierService: GetBySupplierId(item.SupplierId)
        activate SupplierService
        SupplierService -> DB: Query Supplier
        activate DB
        DB --> SupplierService: SupplierDto
        deactivate DB
        SupplierService --> Controller: supplier
        deactivate SupplierService
        Controller -> Controller: item.SupplierName = supplier.SupplierName
    end
end

' Step 6: Response
autonumber 20
Controller --> Manager: Ok(PagedList<ReturnOrderDto>)
deactivate Controller

@enduml